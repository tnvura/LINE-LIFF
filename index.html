<!-- File: /index.html (Minimal LIFF → n8n test) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My First LIFF App — v2025-09-08a</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; }
    .card { max-width: 560px; margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
    .row { display: flex; gap: 12px; align-items: center; }
    #pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #f2f2f2; }
    .muted { color: #6b7280; }
    .btn { display: inline-block; padding: 10px 14px; border-radius: 10px; border: 1px solid #d1d5db; text-decoration: none; cursor: pointer; }
    .btn-primary { background: #06c755; color: #fff; border-color: #06c755; }
    #debug { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background: #f9fafb; border: 1px dashed #d1d5db; padding: 10px; border-radius: 8px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h1>My First LIFF App</h1>
    <p id="status" class="muted">Initializing…</p>

    <div id="profile" style="display:none">
      <div class="row">
        <img id="pic" alt="profile" />
        <div>
          <div id="name" style="font-weight:600; font-size:18px"></div>
          <div id="uid" class="muted"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:16px">
      <a id="login" class="btn btn-primary" href="#" style="display:none">Login</a>
      <a id="open" class="btn" target="_self" style="display:none">Open via LIFF</a>
      <a id="send" class="btn" href="#" style="display:none">Send to n8n</a>
    </div>

    <h3 style="margin-top:24px">Debug</h3>
    <div id="debug">(boot)</div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ======= CONFIG =======
    const LIFF_ID = "2008075804-2AER9wYe";             // your published LIFF ID
    const LIFF_URL = `https://liff.line.me/${LIFF_ID}`;  // launcher
    const WEBHOOK_URL = "https://n8n.tnvura.dev/webhook-test/1044c42f-7f8b-419f-8b02-9650a47623c0"; // n8n test URL
    // If your workflow is ACTIVE, use the production URL instead:
    // const WEBHOOK_URL = "https://n8n.tnvura.dev/webhook/1044c42f-7f8b-419f-8b02-9650a47623c0";
    // =======================

    const el = {
      status: document.getElementById('status'),
      profile: document.getElementById('profile'),
      pic: document.getElementById('pic'),
      name: document.getElementById('name'),
      uid: document.getElementById('uid'),
      login: document.getElementById('login'),
      open: document.getElementById('open'),
      send: document.getElementById('send'),
      debug: document.getElementById('debug'),
    };

    function log(line) { el.debug.textContent += `
${line}`; }
    window.addEventListener('error', (e)=>{ log('window.onerror: ' + e.message); });
    window.addEventListener('unhandledrejection', (e)=>{ log('unhandledrejection: ' + (e.reason?.message || e.reason)); });

    function li() {
      // minimal launch info for troubleshooting
      return [
        `isInClient: ${safe(()=>liff.isInClient())}`,
        `isLoggedIn: ${safe(()=>liff.isLoggedIn())}`,
        `hasToken: ${!!safe(()=>liff.getAccessToken())}`,
      ].join('\n');
    }

    function safe(fn){ try { return fn(); } catch { return '(n/a)'; } }

    function buildPayload(profile){
      return {
        ts: new Date().toISOString(),
        liffId: LIFF_ID,
        isInClient: safe(()=>liff.isInClient()),
        displayName: profile.displayName || null,
        userId: profile.userId || null,
        pictureUrl: profile.pictureUrl || null,
      };
    }

    async function sendToN8N(payload){
      const data = JSON.stringify(payload);

      // A) Beacon (best for in-app browsers; no CORS)
      if (navigator.sendBeacon) {
        try {
          const ok = navigator.sendBeacon(WEBHOOK_URL, new Blob([data], { type: 'text/plain;charset=UTF-8' }));
          log(`beacon -> ${ok ? 'queued' : 'failed'}`);
          if (ok) return true;
        } catch(e){ log(`beacon error: ${e}`); }
      }

      // B) no-cors POST (server still receives; client cannot read response)
      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // simple request (no preflight)
          body: data,
          keepalive: true,
        });
        log('no-cors POST -> sent');
        return true;
      } catch(e){ log(`no-cors error: ${e}`); }

      // C) GET image ping (works even if POST blocked). Requires Webhook node to allow GET.
      try {
        const img = new Image();
        const compact = btoa(unescape(encodeURIComponent(data))).slice(0, 1800);
        const url = `${WEBHOOK_URL}?p=${encodeURIComponent(compact)}&_ts=${Date.now()}`;
        img.src = url;
        log('GET ping -> ' + url);
        return true;
      } catch(e){ log(`GET ping error: ${e}`); }

      return false;
    }

    async function main(){
      el.debug.textContent = '(script loaded)';
      try {
        log('liff.init…');
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        log('liff.init done');
        el.debug.textContent += '
' + li();

        if (!liff.isLoggedIn()) {
          if (liff.isInClient()) {
            el.status.textContent = 'Not launched as LIFF. Tap Open via LIFF.';
            el.open.style.display = 'inline-block';
            el.open.href = LIFF_URL;
            log('not logged in, inClient=true');
            return;
          }
          el.status.textContent = 'Redirecting to LINE Login…';
          log('calling liff.login');
          liff.login({ redirectUri: location.href });
          return;
        }

        el.status.textContent = 'Getting profile…';
        const profile = await liff.getProfile();
        log('got profile');

        el.name.textContent = profile.displayName || '(no name)';
        el.uid.textContent = 'User ID: ' + (profile.userId || '(hidden)');
        if (profile.pictureUrl) el.pic.src = profile.pictureUrl;
        el.profile.style.display = 'block';

        // Auto-send once
        el.status.textContent = 'Sending to n8n…';
        const ok = await sendToN8N(buildPayload(profile));
        el.status.textContent = ok ? 'Sent (or queued). Tap "Send to n8n" to resend.' : 'Send failed.';
        if (ok) log('send ok'); else log('send failed');

        // Manual resend
        el.send.style.display = 'inline-block';
        el.send.onclick = async (e)=>{
          e.preventDefault();
          el.status.textContent = 'Resending…';
          const again = await sendToN8N(buildPayload(profile));
          el.status.textContent = again ? 'Sent (manual).' : 'Still failing.';
          log('manual send: ' + (again ? 'ok' : 'fail'));
        };
      } catch (err) {
        el.status.textContent = 'Error: ' + (err?.message || err);
        log('error: ' + (err?.stack || err));
      }
    });
        el.debug.textContent = li();

        if (!liff.isLoggedIn()) {
          if (liff.isInClient()) {
            el.status.textContent = 'Open via LIFF link to continue.';
            el.open.style.display = 'inline-block';
            el.open.href = LIFF_URL;
            return;
          }
          el.status.textContent = 'Redirecting to LINE Login…';
          liff.login({ redirectUri: location.href });
          return;
        }

        el.status.textContent = 'Getting profile…';
        const profile = await liff.getProfile();

        // Show profile
        el.name.textContent = profile.displayName;
        el.uid.textContent = 'User ID: ' + (profile.userId || '(hidden)');
        if (profile.pictureUrl) el.pic.src = profile.pictureUrl;
        el.profile.style.display = 'block';

        // Auto-send once
        el.status.textContent = 'Sending to n8n…';
        const ok = await sendToN8N(buildPayload(profile));
        el.status.textContent = ok ? 'Sent (or queued). Tap "Send to n8n" to resend.' : 'Send failed.';

        // Manual resend
        el.send.style.display = 'inline-block';
        el.send.onclick = async (e)=>{
          e.preventDefault();
          el.status.textContent = 'Resending…';
          const again = await sendToN8N(buildPayload(profile));
          el.status.textContent = again ? 'Sent (manual).' : 'Still failing.';
        };
      } catch (err) {
        el.status.textContent = 'Error: ' + (err?.message || err);
        log('error: ' + (err?.stack || err));
      }
    }

    main();
  </script>
</body>
</html>
